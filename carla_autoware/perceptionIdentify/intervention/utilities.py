import uuid
from sensor_msgs.msg import PointCloud2, RegionOfInterest
from tier4_perception_msgs.msg import Feature
from sensor_msgs.msg import PointCloud2, PointField
from geometry_msgs.msg import Twist, TwistWithCovariance
import numpy as np
from geometry_msgs.msg import Twist, Vector3
import struct
class ObjectUtils(object):
    def __init__(self):
        self.UNKNOWN=['static.prop.streetbarrier',
        'static.prop.constructioncone',
        'static.prop.trafficcone01',
        'static.prop.trafficcone02',
        'static.prop.warningconstruction',
        'static.prop.warningaccident',
        'static.prop.foodcart',
        'static.prop.trafficwarning',
        ]
        self.CAR = ['vehicle.audi.a2',
        'vehicle.audi.tt',
        'vehicle.mercedes-benz.coupe',
        'vehicle.bmw.grandtourer',
        'vehicle.audi.etron',
        'vehicle.nissan.micra',
        'vehicle.lincoln.mkz_2017',
        'vehicle.dodge.charger_police',
        'vehicle.dodge.charger_police_2020',
        'vehicle.ford.crown',
        'vehicle.tesla.model3',
        'vehicle.toyota.prius',
        'vehicle.seat.leon',
        'vehicle.nissan.patrol',
        'vehicle.mini.cooperst',
        'vehicle.jeep.wrangler_rubicon',
        'vehicle.ford.mustang',
        'vehicle.volkswagen.t2',
        'vehicle.chevrolet.impala',
        'vehicle.dodge.charger_2020',
        'vehicle.citroen.c3']
        self.TRUCK = ['vehicle.carlamotors.carlacola',
        'vehicle.carlamotors.european_hgv',
        'vehicle.carlamotors.firetruck',
        'vehicle.tesla.cybertruck'
        ]
        self.BUS  = ['vehicle.mitsubishi.fusorosa']
        # motorcycle
        self.MOTORCYCLE = ['vehicle.yamaha.yzf',
        'vehicle.harley-davidson.low_rider',
        'vehicle.vespa.zx125',
        'vehicle.kawasaki.ninja']

        self.TRAILER=['vehicle.ford.ambulance',
        'vehicle.mercedes.sprinter',
        'vehicle.volkswagen.t2',
        'vehicle.volkswagen.t2_2021'
        ]
        # cyclist
        self.BICYCLE = ['vehicle.bh.crossbike',
        'vehicle.gazelle.omafiets',
        'vehicle.diamondback.century']
        self.PEDESTRIAN= ['walker.pedestrian.00'+f'{i:02d}' for i in range(1, 49)]
    
    def map_object_type(self, object_id):
            # Check the object_id against each category
        if object_id in self.UNKNOWN:
            return 0
        elif object_id in self.CAR:
            return 1
        elif object_id in self.TRUCK:
            return 2
        elif object_id in self.BUS:
            return 3
        elif object_id in self.MOTORCYCLE:
            return 4
        elif object_id in self.TRAILER:
            return 5
        elif object_id in self.BICYCLE:
            return 6
        elif object_id in self.PEDESTRIAN:
            return 7
        else:
            return 0  # For any object_id that doesn't match the known types

    # Mapping from type to number
    def type_to_number(vehicle_type):
        type_to_number_map = {
            "UNKNOWN": 0,
            "CAR": 1,
            "TRUCK": 2,
            "BUS": 3,
            "TRAILER": 4,
            "MOTORCYCLE": 5,
            "BICYCLE": 6,
            "PEDESTRIAN": 7
        }
        return type_to_number_map.get(vehicle_type, -1)

    def generate_covariance(self, linear_var, angular_var):
        """
        Generate a 6x6 covariance matrix for a TwistWithCovariance message.
        
        Parameters:
        - linear_var: A tuple or list of variances for linear velocity (x, y, z).
        - angular_var: A tuple or list of variances for angular velocity (x, y, z).
        
        Returns:
        - A list of 36 float elements representing the covariance matrix.
        """
        assert len(linear_var) == 3 and all(isinstance(v, float) for v in linear_var), \
            "linear_var must be a sequence of three float values"
        assert len(angular_var) == 3 and all(isinstance(v, float) for v in angular_var), \
            "angular_var must be a sequence of three float values"
        
        # Initialize a 6x6 covariance matrix with all zeros
        covariance_matrix = [[0.0 for _ in range(6)] for _ in range(6)]
        
        # Set the variances for linear velocities
        covariance_matrix[0][0] = linear_var[0]  # Variance of linear velocity in X
        covariance_matrix[1][1] = linear_var[1]  # Variance of linear velocity in Y
        covariance_matrix[2][2] = linear_var[2]  # Variance of linear velocity in Z
        
        # Set the variances for angular velocities
        covariance_matrix[3][3] = angular_var[0]  # Variance of angular velocity around X
        covariance_matrix[4][4] = angular_var[1]  # Variance of angular velocity around Y
        covariance_matrix[5][5] = angular_var[2]  # Variance of angular velocity around Z
        
        # Flatten the matrix to a 1D array with 36 elements
        flat_covariance = [item for sublist in covariance_matrix for item in sublist]
        
        assert len(flat_covariance) == 36 and all(isinstance(v, float) for v in flat_covariance), \
            "The covariance field must be a sequence with length 36 and each value of type 'float'"
        
        return flat_covariance
        
    def generate_uuid_as_uint8_array(self):
        # Generate a random UUID
        random_uuid = uuid.uuid4()
        
        # Convert the UUID to a sequence of bytes
        # The UUID bytes are in big-endian order
        uuid_bytes = random_uuid.bytes
        
        # Convert bytes to a list of uint8 integers
        uuid_uint8_array = [b for b in uuid_bytes]
        
        return uuid_uint8_array

    def generate_roi_feature(self):
        feature =  Feature()
        feature.cluster.header.stamp.sec = 0
        feature.cluster.header.stamp.nanosec =0
        feature.cluster.header.frame_id =''
        feature.cluster.height = 0
        feature.cluster.width = 0
        feature.cluster.fields = []
        feature.cluster.is_bigendian = False
        feature.cluster.point_step = 0
        feature.cluster.row_step = 0
        feature.cluster.data = []
        feature.cluster.is_dense = False
        # TODO: here need a map from actor
        feature.roi.x_offset = 637
        feature.roi.y_offset = 376
        feature.roi.height = 29
        feature.roi.width = 24
        feature.roi.do_rectify = False
        return feature
    
    def generate_cluster_feature(self,header):
        feature =  Feature()
        feature.cluster.header = header
        feature.cluster.header.frame_id ='base_link'
        feature.cluster.height = 1
        feature.cluster.width = 86
        feature.cluster.fields = [
        PointField(name='x', offset=0, datatype=PointField.FLOAT32, count=1),
        PointField(name='y', offset=4, datatype=PointField.FLOAT32, count=1),
        PointField(name='z', offset=8, datatype=PointField.FLOAT32, count=1),
        ]
        feature.cluster.is_bigendian = False
        feature.cluster.point_step = 16
        feature.cluster.row_step = 1376        
        data =[
                64,
                79,
                140,
                65,
                0,
                13,
                143,
                191,
                210,
                137,
                40,
                63,
                0,
                0,
                128,
                63,
                152,
                73,
                140,
                65,
                0,
                150,
                67,
                191,
                244,
                27,
                41,
                63,
                0,
                0,
                128,
                63,
                200,
                71,
                140,
                65,
                0,
                115,
                37,
                191,
                130,
                65,
                41,
                63,
                0,
                0,
                128,
                63,
                48,
                70,
                140,
                65,
                0,
                88,
                7,
                191,
                120,
                97,
                41,
                63,
                0,
                0,
                128,
                63,
                160,
                69,
                140,
                65,
                0,
                104,
                52,
                190,
                12,
                147,
                41,
                63,
                0,
                0,
                128,
                63,
                208,
                72,
                140,
                65,
                0,
                144,
                112,
                61,
                242,
                141,
                41,
                63,
                0,
                0,
                128,
                63,
                48,
                76,
                140,
                65,
                0,
                98,
                150,
                62,
                2,
                115,
                41,
                63,
                0,
                0,
                128,
                63,
                248,
                77,
                140,
                65,
                0,
                144,
                210,
                62,
                66,
                93,
                41,
                63,
                0,
                0,
                128,
                63,
                208,
                79,
                140,
                65,
                0,
                98,
                7,
                63,
                2,
                66,
                41,
                63,
                0,
                0,
                128,
                63,
                168,
                83,
                140,
                65,
                0,
                164,
                67,
                63,
                132,
                250,
                40,
                63,
                0,
                0,
                128,
                63,
                224,
                255,
                139,
                65,
                0,
                228,
                172,
                191,
                104,
                99,
                91,
                63,
                0,
                0,
                128,
                63,
                16,
                242,
                139,
                65,
                0,
                28,
                67,
                191,
                0,
                97,
                92,
                63,
                0,
                0,
                128,
                63,
                160,
                239,
                139,
                65,
                0,
                11,
                37,
                191,
                36,
                132,
                92,
                63,
                0,
                0,
                128,
                63,
                80,
                237,
                139,
                65,
                0,
                3,
                7,
                191,
                210,
                162,
                92,
                63,
                0,
                0,
                128,
                63,
                232,
                234,
                139,
                65,
                0,
                248,
                209,
                190,
                234,
                188,
                92,
                63,
                0,
                0,
                128,
                63,
                120,
                237,
                139,
                65,
                0,
                248,
                51,
                190,
                12,
                205,
                92,
                63,
                0,
                0,
                128,
                63,
                96,
                240,
                139,
                65,
                0,
                208,
                111,
                189,
                42,
                201,
                92,
                63,
                0,
                0,
                128,
                63,
                56,
                243,
                139,
                65,
                0,
                32,
                112,
                61,
                216,
                192,
                92,
                63,
                0,
                0,
                128,
                63,
                184,
                248,
                139,
                65,
                0,
                8,
                150,
                62,
                94,
                162,
                92,
                63,
                0,
                0,
                128,
                63,
                232,
                254,
                139,
                65,
                0,
                22,
                7,
                63,
                36,
                111,
                92,
                63,
                0,
                0,
                128,
                63,
                128,
                3,
                140,
                65,
                0,
                36,
                37,
                63,
                12,
                74,
                92,
                63,
                0,
                0,
                128,
                63,
                16,
                8,
                140,
                65,
                0,
                59,
                67,
                63,
                124,
                32,
                92,
                63,
                0,
                0,
                128,
                63,
                168,
                97,
                140,
                65,
                128,
                129,
                188,
                191,
                247,
                46,
                134,
                63,
                0,
                0,
                128,
                63,
                168,
                75,
                140,
                65,
                0,
                187,
                97,
                191,
                175,
                179,
                134,
                63,
                0,
                0,
                128,
                63,
                136,
                68,
                140,
                65,
                0,
                112,
                37,
                191,
                229,
                215,
                134,
                63,
                0,
                0,
                128,
                63,
                240,
                60,
                140,
                65,
                0,
                78,
                150,
                190,
                145,
                250,
                134,
                63,
                0,
                0,
                128,
                63,
                48,
                68,
                140,
                65,
                0,
                112,
                112,
                189,
                117,
                247,
                134,
                63,
                0,
                0,
                128,
                63,
                120,
                75,
                140,
                65,
                0,
                124,
                52,
                62,
                244,
                235,
                134,
                63,
                0,
                0,
                128,
                63,
                112,
                84,
                140,
                65,
                0,
                156,
                210,
                62,
                17,
                214,
                134,
                63,
                0,
                0,
                128,
                63,
                48,
                98,
                140,
                65,
                0,
                185,
                67,
                63,
                62,
                165,
                134,
                63,
                0,
                0,
                128,
                63,
                112,
                87,
                140,
                65,
                128,
                20,
                143,
                191,
                250,
                147,
                159,
                63,
                0,
                0,
                128,
                63,
                120,
                55,
                140,
                65,
                0,
                108,
                210,
                190,
                112,
                253,
                159,
                63,
                0,
                0,
                128,
                63,
                144,
                65,
                140,
                65,
                0,
                112,
                112,
                189,
                236,
                252,
                159,
                63,
                0,
                0,
                128,
                63,
                72,
                71,
                140,
                65,
                0,
                144,
                112,
                61,
                137,
                246,
                159,
                63,
                0,
                0,
                128,
                63,
                8,
                77,
                140,
                65,
                0,
                120,
                52,
                62,
                112,
                238,
                159,
                63,
                0,
                0,
                128,
                63,
                120,
                91,
                140,
                65,
                0,
                111,
                7,
                63,
                74,
                206,
                159,
                63,
                0,
                0,
                128,
                63,
                192,
                94,
                140,
                65,
                0,
                148,
                37,
                63,
                174,
                193,
                159,
                63,
                0,
                0,
                128,
                63,
                128,
                102,
                140,
                65,
                0,
                136,
                188,
                191,
                46,
                93,
                184,
                63,
                0,
                0,
                128,
                63,
                64,
                86,
                140,
                65,
                128,
                19,
                143,
                191,
                42,
                158,
                184,
                63,
                0,
                0,
                128,
                63,
                192,
                64,
                140,
                65,
                0,
                107,
                37,
                191,
                102,
                223,
                184,
                63,
                0,
                0,
                128,
                63,
                168,
                57,
                140,
                65,
                0,
                76,
                7,
                191,
                130,
                237,
                184,
                63,
                0,
                0,
                128,
                63,
                48,
                50,
                140,
                65,
                0,
                98,
                210,
                190,
                120,
                250,
                184,
                63,
                0,
                0,
                128,
                63,
                104,
                48,
                140,
                65,
                0,
                64,
                150,
                190,
                161,
                0,
                185,
                63,
                0,
                0,
                128,
                63,
                208,
                63,
                140,
                65,
                0,
                96,
                112,
                189,
                193,
                246,
                184,
                63,
                0,
                0,
                128,
                63,
                136,
                69,
                140,
                65,
                0,
                144,
                112,
                61,
                129,
                241,
                184,
                63,
                0,
                0,
                128,
                63,
                152,
                80,
                140,
                65,
                0,
                106,
                150,
                62,
                146,
                226,
                184,
                63,
                0,
                0,
                128,
                63,
                200,
                91,
                140,
                65,
                0,
                113,
                7,
                63,
                143,
                205,
                184,
                63,
                0,
                0,
                128,
                63,
                104,
                97,
                140,
                65,
                0,
                149,
                37,
                63,
                215,
                192,
                184,
                63,
                0,
                0,
                128,
                63,
                16,
                92,
                140,
                65,
                128,
                53,
                158,
                191,
                16,
                142,
                209,
                63,
                0,
                0,
                128,
                63,
                88,
                66,
                140,
                65,
                0,
                137,
                67,
                191,
                228,
                202,
                209,
                63,
                0,
                0,
                128,
                63,
                200,
                43,
                140,
                65,
                0,
                90,
                210,
                190,
                40,
                238,
                209,
                63,
                0,
                0,
                128,
                63,
                192,
                49,
                140,
                65,
                0,
                76,
                52,
                190,
                178,
                239,
                209,
                63,
                0,
                0,
                128,
                63,
                128,
                57,
                140,
                65,
                0,
                80,
                112,
                189,
                34,
                235,
                209,
                63,
                0,
                0,
                128,
                63,
                48,
                65,
                140,
                65,
                0,
                144,
                112,
                61,
                90,
                229,
                209,
                63,
                0,
                0,
                128,
                63,
                168,
                80,
                140,
                65,
                0,
                104,
                150,
                62,
                10,
                214,
                209,
                63,
                0,
                0,
                128,
                63,
                192,
                86,
                140,
                65,
                0,
                158,
                210,
                62,
                233,
                205,
                209,
                63,
                0,
                0,
                128,
                63,
                56,
                92,
                140,
                65,
                0,
                112,
                7,
                63,
                202,
                196,
                209,
                63,
                0,
                0,
                128,
                63,
                72,
                90,
                140,
                65,
                0,
                52,
                158,
                191,
                228,
                140,
                234,
                63,
                0,
                0,
                128,
                63,
                200,
                82,
                140,
                65,
                128,
                16,
                143,
                191,
                140,
                154,
                234,
                63,
                0,
                0,
                128,
                63,
                16,
                75,
                140,
                65,
                0,
                225,
                127,
                191,
                82,
                167,
                234,
                63,
                0,
                0,
                128,
                63,
                16,
                60,
                140,
                65,
                0,
                131,
                67,
                191,
                9,
                190,
                234,
                63,
                0,
                0,
                128,
                63,
                16,
                45,
                140,
                65,
                0,
                64,
                7,
                191,
                220,
                208,
                234,
                63,
                0,
                0,
                128,
                63,
                144,
                37,
                140,
                65,
                0,
                82,
                210,
                190,
                238,
                216,
                234,
                63,
                0,
                0,
                128,
                63,
                152,
                43,
                140,
                65,
                0,
                68,
                52,
                190,
                28,
                218,
                234,
                63,
                0,
                0,
                128,
                63,
                64,
                51,
                140,
                65,
                0,
                64,
                112,
                189,
                158,
                214,
                234,
                63,
                0,
                0,
                128,
                63,
                248,
                58,
                140,
                65,
                0,
                144,
                112,
                61,
                34,
                210,
                234,
                63,
                0,
                0,
                128,
                63,
                144,
                97,
                140,
                65,
                0,
                149,
                37,
                63,
                254,
                173,
                234,
                63,
                0,
                0,
                128,
                63,
                224,
                103,
                140,
                65,
                0,
                193,
                67,
                63,
                201,
                164,
                234,
                63,
                0,
                0,
                128,
                63,
                192,
                104,
                140,
                65,
                128,
                101,
                173,
                191,
                44,
                188,
                1,
                64,
                0,
                0,
                128,
                63,
                144,
                97,
                140,
                65,
                0,
                59,
                158,
                191,
                44,
                193,
                1,
                64,
                0,
                0,
                128,
                63,
                0,
                69,
                140,
                65,
                0,
                140,
                67,
                191,
                222,
                209,
                1,
                64,
                0,
                0,
                128,
                63,
                232,
                61,
                140,
                65,
                0,
                103,
                37,
                191,
                53,
                213,
                1,
                64,
                0,
                0,
                128,
                63,
                208,
                43,
                140,
                65,
                0,
                90,
                210,
                190,
                175,
                219,
                1,
                64,
                0,
                0,
                128,
                63,
                0,
                68,
                140,
                65,
                0,
                160,
                112,
                61,
                210,
                216,
                1,
                64,
                0,
                0,
                128,
                63,
                168,
                82,
                140,
                65,
                0,
                108,
                150,
                62,
                236,
                212,
                1,
                64,
                0,
                0,
                128,
                63,
                0,
                90,
                140,
                65,
                0,
                164,
                210,
                62,
                122,
                210,
                1,
                64,
                0,
                0,
                128,
                63,
                8,
                115,
                140,
                65,
                0,
                116,
                173,
                191,
                79,
                56,
                14,
                64,
                0,
                0,
                128,
                63,
                128,
                93,
                140,
                65,
                0,
                3,
                128,
                191,
                29,
                64,
                14,
                64,
                0,
                0,
                128,
                63,
                152,
                67,
                140,
                65,
                0,
                112,
                37,
                191,
                186,
                70,
                14,
                64,
                0,
                0,
                128,
                63,
                80,
                56,
                140,
                65,
                0,
                88,
                52,
                190,
                119,
                74,
                14,
                64,
                0,
                0,
                128,
                63,
                192,
                84,
                140,
                65,
                0,
                124,
                52,
                62,
                79,
                71,
                14,
                64,
                0,
                0,
                128,
                63,
                72,
                100,
                140,
                65,
                0,
                176,
                210,
                62,
                189,
                68,
                14,
                64,
                0,
                0,
                128,
                63,
                136,
                107,
                140,
                65,
                0,
                126,
                7,
                63,
                50,
                67,
                14,
                64,
                0,
                0,
                128,
                63,
                0,
                110,
                140,
                65,
                0,
                44,
                143,
                191,
                96,
                182,
                26,
                64,
                0,
                0,
                128,
                63,
                168,
                100,
                140,
                65,
                0,
                8,
                128,
                191,
                235,
                182,
                26,
                64,
                0,
                0,
                128,
                63,
                192,
                72,
                140,
                65,
                0,
                117,
                37,
                191,
                67,
                184,
                26,
                64,
                0,
                0,
                128,
                63,
                104,
                63,
                140,
                65,
                0,
                81,
                7,
                191,
                167,
                184,
                26,
                64,
                0,
                0,
                128,
                63,
                40,
                54,
                140,
                65,
                0,
                104,
                210,
                190,
                5,
                185,
                26,
                64,
                0,
                0,
                128,
                63,
                0,
                52,
                140,
                65,
                0,
                72,
                150,
                190,
                41,
                185,
                26,
                64,
                0,
                0,
                128,
                63,
                240,
                89,
                140,
                65,
                0,
                132,
                52,
                62,
                105,
                184,
                26,
                64,
                0,
                0,
                128,
                63,
                248,
                108,
                140,
                65,
                0,
                192,
                210,
                62,
                206,
                183,
                26,
                64,
                0,
                0,
                128,
                63,
                200,
                117,
                140,
                65,
                0,
                135,
                7,
                63,
                113,
                183,
                26,
                64,
                0,
                0,
                128,
                63
            ]       
        # TODO: here need a map from actor
        feature.cluster.data = data
        feature.roi.x_offset = 0
        feature.roi.y_offset = 0  
        feature.roi.height = 0
        feature.roi.width = 0
        feature.roi.do_rectify = False
        return feature