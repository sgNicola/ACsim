# IRCA

IRCA is a root cause analysis frame work for root cause analysis in perception failure in autonomous driving system.  IRCA has two main goals: (1) Finding the perception modules responsible for the failure; and (2) Identifying the specific fault modes at the message level that caused the failure.  This project is the framework of IRCA, it uses the CARLA simulator to run with autonomous driving system Autoware.  Within the framework of IRCA, these failure scenarios generated by CARLA simulator serve as the initial inputs for conducting root cause analysis (RCA).  

## Environment requirements

#### **Hardware Requirements:**  

**GPU:** 8 GB, **CPU:** 8 cores, **RAM:** 16 GB, **Disk Space:** At least 40 GB

#### Software Dependencies:

##### Operating System: **Ubuntu 20.04**

##### ROS 2:

- **Distribution:** ROS 2 Galactic
- **System Dependencies:** Refer to [REP-2000](https://www.ros.org/reps/rep-2000.html) for detailed ROS 2 system dependencies.

##### Additional Software and Tools:

- **ROS 2 Dev Tools:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/ros2_dev_tools#manual-installation)
- **RMW Implementation:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/rmw_implementation#manual-installation)
- **Pacmod:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/rmw_implementation#manual-installation)
- **Autoware Core Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/autoware_core#manual-installation)
- **Autoware Universe Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/autoware_universe#manual-installation)
- **Pre-commit Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/pre_commit#manual-installation)
- **Nvidia CUDA:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/cuda#manual-installation)
- **Nvidia cuDNN and TensorRT:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/tensorrt#manual-installation)

Please ensure all the above requirements are met and configured properly before proceeding with the project testing to avoid any compatibility or performance issues.

## Installation

### 1. Cloning the Repository

First, clone this repository into the `~/ACsim` workspace. 

### 2. Install Autoware.universe 

We are integrating Autoware.Universe Galactic version tailored for ADS development, enriched with fault injection capabilities and enhanced packages for simulation synchronization with CARLA.

##### Installing Dependencies Using Ansible

Navigate to the autoware directory and set up the development environment:

```
cd ~/ACsim/autoware
./setup-dev-env.sh
```

This script will install all required dependencies and can take up to an hour. After completion, you should see a `Completed` message.

##### Install Dependent ROS Packages

Before building Autoware, ensure all ROS 2 dependencies are installed:

```
source /opt/ros/galactic/setup.bash
rosdep update --include-eol-distros
rosdep install -y --from-paths src --ignore-src --rosdistro galactic
```

##### Build Autoware

Please use `colcon` to compile the Autoware workspace:

```
colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
```

Upon successful build, you should see `247 packages finished`.

### 3. Package Installation of CARLA 0.9.14

Now, navigate back to the `~/ACsim` root and prepare for CARLA installation:

```
cd ~/ACsim
```

Follow the **[CARLA Quick Start Package Installation Guide](https://carla.readthedocs.io/en/0.9.14/start_quickstart/#b-package-installation)** to download and install CARLA 0.9.14.  

### 4. Prepare Map data

#### Step 1: Download Map Data

Firstly, you need to clone the Autoware contents repository from Bitbucket that contains map data compatible with CARLA. You can do this by running the following Git command:

```
git clone https://bitbucket.org/carla-simulator/autoware-contents.git
```

This command will download the repository containing the needed map data such as point cloud maps, vector maps (lanelet2).

#### Step 2: Create Folders for Map Data

You need to create a series of folders under the `~/ACsim` path for storing map data for different town simulations from Town01 to Town10. You can use the following shell command to create these directories:

```
mkdir -p ~/ACsim/map_data/Town{01..10}
```

#### Step 3: Rename and Move Maps

You will then need to rename specific map files and relocate them to their corresponding directories. For Town01, as an example, the operations would be:

```
# Navigate to the directory where you cloned the repository
cd autoware-contents
# Move and rename the lanelet2 map for Town01
cp maps/vector_maps/lanelet2/Town01.osm ~/ACsim/map_data/Town01/lanelet2_map.osm

# Move and rename the point cloud map for Town01
cp maps/point_cloud_maps/Town01.pcd ~/ACsim/map_data/Town01/pointcloud_map.pcd
```

You would repeat similar steps for other towns (Town02 to Town10) accordingly, adjusting the source and destination filenames and paths.

#### Step 4: Verify Folder Contents

Each folder under `~/ACsim/map_data/TownXX` should contain two types of maps:

- `lanelet2_map.osm`
- `pointcloud_map.pcd`

## Configuration

### 1. Enabling Localhost-Only Communication and Kernel Buffer Size Adjustment

Before launching Autoware, ensure your system is configured to use localhost-only communication and has sufficient kernel buffer sizes for handling large amounts of data. Add the following commands to bashrc :

```
export ROS_LOCALHOST_ONLY=1
echo "your_sudo_password" | sudo -S sysctl -w net.core.rmem_max=2147483647
echo "your_sudo_password" | sudo -S ip link set lo multicast on
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
```

**Note:** Replace `"your_sudo_password"` with your actual sudo password to automate the command execution.

### 2. Update Path References

Ensure your workspace path matches the environment variable settings. Replace `/home/user/ACsim/` with your actual workspace directory in the files listed in the `~/ACsim/carla_autoware/path_list.md` . 

### 3. Environment setup (bashrc):

```
export UE4_ROOT=~/UnrealEngine_4.26
export CARLA_ROOT=/home/anonymous/ACsim/CARLA_0.9.14
export SCENARIO_RUNNER_ROOT=/home/anonymous/ACsim/carla_autoware/scenario_runner
export LEADERBOARD_ROOT=/home/anonymous/ACsim/carla_autoware/op_bridge
export TEAM_CODE_ROOT=/home/anonymous/ACsim/carla_autoware/op_agent
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/util
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla/agents
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla/dist/carla-0.9.14-py3.7-linux-x86_64.egg
export PYTHONPATH=$PYTHONPATH:${SCENARIO_RUNNER_ROOT}
```

**Note:** Replace `"anonymous"` with your actual user name.

### 4. Create folder for saving data:

This guide walks you through the steps to create specific directories in your system needed for storing object data and ROS2 bag files. Ensure you have the appropriate permissions to create directories in the desired locations.

**Object Data Directory:**  

```
mkdir -p /home/anonymous/workspace/home/Data/ObjectData/
```

**ROS2 Bags Directory**: For storing ROS2 bag files, another directory is needed, which will be located on your SSD for fast read/write access. 

```
mkdir -p /home/anonymous/ssd/
```

**Note:** Replace `"anonymous"` with your actual path.

## Evaluation

This experiment aims to:

1. Assess the functionality of the automated IRCA framework.
2. Evaluate its effectiveness in real-world fault scenarios, as detailed in Table III.
3. Evaluate its efficiency.

### **Preparation:**

The experiment involves testing three Multi-Sensor Fusion Configurations (MSF) in Autoware:

#### Multi-Sensor Fusion Configurations (MSF) in Autoware

1. **Camera-Lidar Fusion Configuration**: This is the default configuration in our project.

2. **Lidar-Fusion Configuration**:  For the Lidar-Fusion setup, you need to update the launch arguments in two main files to ensure the system  Configuration:

   1. **Autoware Launch File**
      Path: `autoware/src/launcher/autoware_launch/autoware_launch/launch/autoware.launch.xml`
      Change the line 129 from:

      ```
      <arg name="mode" value="camera_lidar_fusion"/>
      ```

      To:

      ```
      <arg name="mode" value="lidar"/>
      ```

   2. **Object Recognition Launch File**
      Path: `autoware/src/universe/autoware.universe/launch/tier4_perception_launch/launch/object_recognition/detection/detection.launch.xml`
      Modify line 4 from:

      ```
      <arg name="mode" default="camera_lidar_fusion" description="options: `camera_lidar_radar_fusion`, `camera_lidar_fusion`, `lidar_radar_fusion`, `lidar` or `radar`"/>
      ```

      To:

      ```
      <arg name="mode" default="lidar" description="options: `camera_lidar_radar_fusion`, `camera_lidar_fusion`, `lidar_radar_fusion`, `lidar` or `radar`"/>
      ```

3. **Cluster Configuration**: This configuration uses a clustering approach for sensor data fusion. The same configuration files in Autoware as 2. Lidar-fusion. 

## Results

