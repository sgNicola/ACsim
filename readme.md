# IRCA

IRCA is a root cause analysis frame work for root cause analysis in perception failure in autonomous driving system.  IRCA has two main goals: (1) Finding the perception modules responsible for the failure; and (2) Identifying the specific fault modes at the message level that caused the failure.  This project is the framework of IRCA, it uses the CARLA simulator to run with autonomous driving system Autoware.  Within the framework of IRCA, these failure scenarios generated by CARLA simulator serve as the initial inputs for conducting root cause analysis (RCA).  

## Environment requirements

#### **Hardware Requirements:**  

**GPU:** 8 GB, **CPU:** 8 cores, **RAM:** 16 GB, **Disk Space:** At least 40 GB

#### Software Dependencies:

##### Operating System: **Ubuntu 20.04**

##### ROS 2:

- **Distribution:** ROS 2 Galactic
- **System Dependencies:** Refer to [REP-2000](https://www.ros.org/reps/rep-2000.html) for detailed ROS 2 system dependencies.

##### Additional Software and Tools:

- **ROS 2 Dev Tools:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/ros2_dev_tools#manual-installation)
- **RMW Implementation:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/rmw_implementation#manual-installation)
- **Pacmod:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/rmw_implementation#manual-installation)
- **Autoware Core Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/autoware_core#manual-installation)
- **Autoware Universe Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/autoware_universe#manual-installation)
- **Pre-commit Dependencies:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/pre_commit#manual-installation)
- **Nvidia CUDA:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/cuda#manual-installation)
- **Nvidia cuDNN and TensorRT:** [Manual Installation Instructions](https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/tensorrt#manual-installation)

Please ensure all the above requirements are met and configured properly before proceeding with the project testing to avoid any compatibility or performance issues.

## Installation

### 1. Cloning the Repository

First, clone this repository into the `~/ACsim` workspace. 

### 2. Install Autoware.universe 

We are integrating Autoware.Universe Galactic version tailored for ADS development, enriched with fault injection capabilities and enhanced packages for simulation synchronization with CARLA.

For the convenience of experiment, we recommend installing Autoware in a separate workspace.

##### Installing Dependencies Using Ansible

Navigate to the autoware directory and set up the development environment:

```
cd ~/ACsim/autoware
./setup-dev-env.sh
```

This script will install all required dependencies and can take up to an hour. After completion, you should see a `Completed` message.

##### Install Dependent ROS Packages

Before building Autoware, ensure all ROS 2 dependencies are installed:

```
source /opt/ros/galactic/setup.bash
rosdep update --include-eol-distros
rosdep install -y --from-paths src --ignore-src --rosdistro galactic
```

##### Build Autoware

Please use `colcon` to compile the Autoware workspace:

```
colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
```

Upon successful build, you should see `247 packages finished`.

### 3. Package Installation of CARLA 0.9.14

Now, navigate back to the `~/ACsim` root and prepare for CARLA installation:

```
cd ~/ACsim
```

Follow the **[CARLA Quick Start Package Installation Guide](https://carla.readthedocs.io/en/0.9.14/start_quickstart/#b-package-installation)** to download and install CARLA 0.9.14.  

### 4. Prepare Map data

#### Step 1: Download Map Data

Firstly, you need to clone the Autoware contents repository from Bitbucket that contains map data compatible with CARLA. You can do this by running the following Git command:

```shell
git clone https://bitbucket.org/carla-simulator/autoware-contents.git
```

This command will download the repository containing the needed map data such as point cloud maps, vector maps (lanelet2).

#### Step 2: Create Folders for Map Data

You need to create a series of folders under the `~/ACsim` path for storing map data for different town simulations from Town01 to Town10. You can use the following shell command to create these directories:

```shell
mkdir -p ~/ACsim/map_data/Town{01..10}
```

#### Step 3: Rename and Move Maps

You will then need to rename specific map files and relocate them to their corresponding directories. For Town01, as an example, the operations would be:

```shell
# Navigate to the directory where you cloned the repository
cd autoware-contents
# Move and rename the lanelet2 map for Town01
cp maps/vector_maps/lanelet2/Town01.osm ~/ACsim/map_data/Town01/lanelet2_map.osm

# Move and rename the point cloud map for Town01
cp maps/point_cloud_maps/Town01.pcd ~/ACsim/map_data/Town01/pointcloud_map.pcd
```

You would repeat similar steps for other towns (Town02 to Town10) accordingly, adjusting the source and destination filenames and paths.

#### Step 4: Verify Folder Contents

Each folder under `~/ACsim/map_data/TownXX` should contain two types of maps:

- `lanelet2_map.osm`
- `pointcloud_map.pcd`

## Configuration

### 1. Enabling Localhost-Only Communication and Kernel Buffer Size Adjustment

Before launching Autoware, ensure your system is configured to use localhost-only communication and has sufficient kernel buffer sizes for handling large amounts of data. Add the following commands to bashrc :

```basic
export ROS_LOCALHOST_ONLY=1
echo "your_sudo_password" | sudo -S sysctl -w net.core.rmem_max=2147483647
echo "your_sudo_password" | sudo -S ip link set lo multicast on
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
```

**Note:** Replace `"your_sudo_password"` with your actual sudo password to automate the command execution.

### 2. Update Path References

Ensure your workspace path matches the environment variable settings. Replace `/home/user/ACsim/` with your actual workspace directory in the files listed in the `~/ACsim/carla_autoware/path_list.md` . 

### 3. Environment setup (bashrc):

```basic
export UE4_ROOT=~/UnrealEngine_4.26
export CARLA_ROOT=/home/anonymous/ACsim/CARLA_0.9.14
export SCENARIO_RUNNER_ROOT=/home/anonymous/ACsim/carla_autoware/scenario_runner
export LEADERBOARD_ROOT=/home/anonymous/ACsim/carla_autoware/op_bridge
export TEAM_CODE_ROOT=/home/anonymous/ACsim/carla_autoware/op_agent
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/util
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla/agents
export PYTHONPATH=$PYTHONPATH:${CARLA_ROOT}/PythonAPI/carla/dist/carla-0.9.14-py3.7-linux-x86_64.egg
export PYTHONPATH=$PYTHONPATH:${SCENARIO_RUNNER_ROOT}
```

**Note:** Replace `"anonymous"` with your actual user name.

### 4. Create folder for saving data:

This guide walks you through the steps to create specific directories in your system needed for storing object data and ROS2 bag files. Ensure you have the appropriate permissions to create directories in the desired locations.

**Object Data Directory:**  

```
mkdir -p /home/anonymous/workspace/home/Data/ObjectData/
```

**ROS2 Bags Directory**: For storing ROS2 bag files, another directory is needed, which will be located on your SSD for fast read/write access. 

```
mkdir -p /home/anonymous/ssd/
```

**Note:** Replace `"anonymous"` with your actual path.

## Evaluation

#### Experiment (E1)
**[Real fault scenarios] [20 human-minutes + 200 compute-hours]:** This experiment aims to:
- Assess the functionality of the automated IRCA framework.
- Evaluate its effectiveness in real-world fault scenarios, as detailed in [Table III].
- Evaluate its efficiency as detailed in [Table VI].

**[Preparation]**

1. **Multi-Sensor Fusion Configurations (MSF) in Autoware**: 
   - Use the default configuration: Camera-Lidar-Fusion Configuration.
   
2. **Scenario Parameters Configuration**:
   
   - Configure each group with a specific scenario configuration. In this experiment, it should be like this in fusion_hira.py
   
     ```
     scenario="Cone"
         X1 = [8,10,-2,6,-1,0,1,3,5,7,9,-3,2,4]
         Y1 = [-1,-0,1,-0.5]
         object_types=['static.prop.streetbarrier',
             'static.prop.constructioncone',
             'static.prop.trafficcone01',
             'static.prop.trafficcone02',
             'static.prop.warningconstruction',
             'static.prop.warningaccident',
             ]
         params = {
             "X1": 0,
             "Y1": 0,
             "object_type": None
         }
     ```
   
     
   
3. **Failure Modes Configuration**:
   
   - Configure failure mode arguments in `param.py` based on the definitions provided in TABLE I. Mappings include: `{false_negative: Missing Obstacle, false_positive: Ghost Obstacle, wrong_localization: Mislocalization, wrong_classification: Misclassification}`.

**[Execution]**

- **Main Script:** Execute `source ~/ACsim/autoware/install/setup.sh && python3 fusion_hira.py`.
- **Experiment Workflow:**
  - **Initialization:**
    - This framework will start the Carla server to simulate driving scenarios based on the configured scenario parameters.
    -  The Autoware system is launched along with the generated scenarios.
  - **First Iteration:**
    - Generate Scenarios either randomly or as per specification to test different driving conditions.
    - Start Autoware with the generated scenarios.
    - **Data Recording:**
      - Record perception outputs in ROS 2 bags in the specified `ROSbag_directory`.
      - Process the ROS 2 bag messages and save the data in `Object_Directory`.
    - **Failure Mode Analysis:**
      - Identify failure modes in the modules.
      - Record these modes in `(Execution_id)_object_(id)/_(failure_mode).csv`.
      - If the final output in the perception system matches the pre-configured failure mode, it will trigger the second iteration for root cause analysis.
  - **Subsequent Iterations:**
    - The main difference in the subsequent iteration is the **Intervention**: IRCA will start an intervention node in a new terminal session and display intervention details in the terminal.
    - Repeat data recording and analysis as in the first iteration.
    - Adjust interventions based on ongoing analysis until root causes are understood.
  - **Completion:**
    - Conclude the experiment cycles once root cause analysis is completed and save the final results in `/ACsim/carla_autoware/results.csv`.

**[Results]**

- This experiment is just for demonstrating functionality, it is not enough for calculate the final results which require at least 100 experiments.
- Check the data files: please back up your data in `/home/anonymous/workspace/home/Data/ObjectData/` ，  `/home/anonymous/ssd/` ，  `(Execution_id)_object_(id)/_(failure_mode).csv` and ` ~/ACsim/CausalAnalysis`. Then clean these data folders for next experiments.

#### Experiment (E2)
**[Real fault scenarios] [20 human-minutes + 200 compute-hours]:** This experiment aims to evaluate its effectiveness in real-world fault scenarios of groups 1-2, as detailed in [Table III].

**[Preparation]**

1. **Multi-Sensor Fusion Configurations (MSF) in Autoware**:  

   - **Lidar-Fusion Configuration:** For the Lidar-Fusion setup, update the launch arguments in `autoware.launch.xml` and `detection.launch.xml`.

   - please check the file path in `/ACsim/carla_autoware/op_agent/start_ros2.sh` , and change the launch file under the autoware workspace with `source /home/wsg/XX/autoware/XX`

     1. 1. **Autoware Launch File**
           Path: `autoware/src/launcher/autoware_launch/autoware_launch/launch/autoware.launch.xml`
           Change the line 129 from:

           ```xml
           <arg name="mode" value="camera_lidar_fusion"/>
           ```

           To:

           ```xml
           <arg name="mode" value="lidar"/>
           ```

        2. **Object Recognition Launch File**
           Path: `autoware/src/universe/autoware.universe/launch/tier4_perception_launch/launch/object_recognition/detection/detection.launch.xml`
           Modify line 4 from:

           ```xml
           <arg name="mode" default="camera_lidar_fusion" description="options: `camera_lidar_radar_fusion`, `camera_lidar_fusion`, `lidar_radar_fusion`, `lidar` or `radar`"/>
           ```

           To:

           ```xml
           <arg name="mode" default="lidar" description="options: `camera_lidar_radar_fusion`, `camera_lidar_fusion`, `lidar_radar_fusion`, `lidar` or `radar`"/>
           ```

2. **Scenario Parameters Configuration**: Configure scenarios for group ids `{1:truck}` as listed in TABLE III.

   **Please note that we can only configure one type of scenarios at once **

   1: Truck, please keep the configuration in `lidar_hira.py`. from 148- 157 lines

   ```
       scenario='Truck'
       params = {
       "X1": 0,
       "Y1": 0,
       "object_type": None
       }
       X1 =[5,6,6.5,7,7.5,8,8.5,9,9.5,10]
       Y1 =[0,-1,-0.5]
       object_types =['vehicle.mitsubishi.fusorosa','vehicle.mitsubishi.fusorosa','vehicle.mitsubishi.fusorosa','vehicle.mitsubishi.fusorosa']
       run_experiments(X1, Y1, object_types)
   ```

   2: Truck_walker, please keep the configuration in `lidar_hira.py`. from 159- 170 lines

   ```
        scenario="Truck_walker"
       X1 =[5,6,6.5,7,7.5,8,8.5,9,9.5,10]
       Y1 =[0,-1,-0.5]
       object_types =['vehicle.bh.crossbike','vehicle.gazelle.omafiets',
                      'vehicle.diamondback.century']
       object_types =['vehicle.mitsubishi.fusorosa','vehicle.tesla.cybertruck']
       params = {
           "X1": 0,
           "Y1": 0,
           "object_type": None
       }
       run_experiments(X1, Y1, object_types)
   ```

   For example, we can keep the configuration of scenario 'Truck' , and comment out other configurations.

3. **Failure Modes Configuration**: Configure failure mode arguments as `false_negative` in `ACsim/carla_autoware/param.py` based on definitions in TABLE I.

4. **Lidar-Fusion Configuration**:

   - Change line 6, 10 in `ACsim/carla_autoware/perceptionIdentify/utils.py` to import specific modules for Lidar processing: from

     ```python
     from run_fusion import run_carla_scenario_agent
     ```

     to:

     ```python
     from run_lidar import run_carla_scenario_agent
     ```

     change:

     ```python
     from perceptionIdentify.parse_fusion import record_intervene
     ```

     to:

     ```python
     from perceptionIdentify.parse_lidar import record_intervene
     ```

   - Change line 45 in `ACsim/carla_autoware/perceptionIdentify/process_rosbag.py` 

     ```
     config = load_config('/home/wsg/ACsim/carla_autoware/perceptionIdentify/fusion_config.yaml')
     ```

     to

     ```
     config = load_config('/home/wsg/ACsim/carla_autoware/perceptionIdentify/lidar_config.yaml')
     ```

     

     Ensure the launch files are the same as you have configured.

**[Execution]**

- Please enter into carla_autoware in terminal.

  ```
  cd ~/ACsim/carla_autoware
  ```

- Execute  `source ~/ACsim/autoware/install/setup.sh && python3 lidar_hira.py`, with other steps the are same as E1.

#### Experiment (E3) 
**[Real fault scenarios] [20 human-minutes + 200 compute-hours]:** This experiment aims to evaluate its effectiveness in real-world fault scenarios of groups 6-7, as detailed in [Table III].

**[Preparation]**

1. **Cluster configuration**:

   - [ ] Modify  `lidar_hira.py` to use the appropriate modules for cluster-based processing.

     change

     ```python
     from run_lidar import run_carla_scenario_agent 
     ```

     to

     ```python
     from run_cluster import run_carla_scenario_agent
     ```

**[Execution]**

- Please enter into carla_autoware in terminal.

  ```
  cd ~/ACsim/carla_autoware
  ```

-  Execute `source ~/ACsim/autoware/install/setup.sh && python3 lidar_hira.py`.

The execution steps are the same as in E2, maintaining consistency across experiments for comparability and analysis.

#### Experiment (E4)

**Duration:** 10 human-minutes + 200 compute-hours

**Objective:** This experiment aims to evaluate the effectiveness and efficiency in synthetic fault scenarios for groups 8-17, as detailed in Table IV and Table V.

**Scenario Parameters Configuration **: Configure scenarios in ACsim/carla_autoware/lidar_hira.py in lines 133-146

```
    scenario="Car"
    X1=[-10,0,-5,-7,-9,-3,-2,-4,-8,-6]
    Y1 = [-1,0,0.6]
    object_types=['vehicle.tesla.model3',
        'vehicle.toyota.prius',
        'vehicle.audi.tt',
        'vehicle.jeep.wrangler_rubicon'
        ]
    params = {
        "X1": 0,
        "Y1": 0,
        "object_type": None
    }
    run_experiments(X1, Y1, object_types)
```

and comment out other scenario configuration in lines 148-157, 159-170

#### Fault Injection

To inject faults as listed in Table II ("Module with Fault"), please update the arguments for each module in the script `ACsim/carla_autoware/op_agent/start_ros2.sh`.

```shell
ros2 launch /home/wsg/ACsim/autoware/src/launcher/autoware_launch/autoware_launch/launch/autoware.launch.xml map_path:=/home/anonymous/ACsim/map_data/${map_name} vehicle_model:=sample_vehicle sensor_model:=sample_sensor_kit yolo_faulty_mode:=0 lidar_faulty_mode:=0 validation_faulty_mode:=0 shape_faulty_mode:=0 fusion_faulty_mode:=0 merger_faulty_mode:=0 dbt_faulty_mode:=0 tracker_faulty_mode:=0 yolo_timeLatencyDuration:=0 lidar_timeLatencyDuration:=0 shape_timeLatencyDuration:=0 fusion_timeLatencyDuration:=0 merger_timeLatencyDuration:=0 dbt_timeLatencyDuration:=0 tracker_timeLatencyDuration:=0
```

**Fault Modes Definition:**

- `0`: Normal
- `1`: MO
- `2`: GO
- `3`: ML
- `4`: MC

**Module IDs and Corresponding Arguments for Lidar-fusion configuration:**

`1`: `lidar_faulty_mode`

`4`: `validation_faulty_mode`

`5`: `fusion_faulty_mode`

`8`: `shape_faulty_mode`

`9`: `merger_faulty_mode`

`10`: `tracker_faulty_mode`

**Module IDs and Corresponding Arguments for Camera-Lidar-fusion configuration:**

- `1`: `lidar_faulty_mode`

- `3`: `yolo_faulty_mode`

- `4`: `validation_faulty_mode`

- `5`: `fusion_faulty_mode`

- `6`: `shape_faulty_mode`

- `7`: `merger_faulty_mode`

- `10`: `tracker_faulty_mode`

  **Note that although the arguments 6 and 7 are the same in the Lidar-fusion configuration, they correspond to different nodes in separate launch files  **

To assign an MO fault to the Tracker Module, update the argument to: `tracker_faulty_mode:=1`.

**For example in Experiment ID 10**, Module with fault  {10: MO} , it means that we injected an MO fault in  module  `10`: `tracker_faulty_mode`, therefore, we should update the argument from `tracker_faulty_mode:=0`  to: `tracker_faulty_mode:=1`. Then source command in the start_ros2.sh is like this.

```
ros2 launch /home/wsg/ACsim/autoware/src/launcher/autoware_launch/autoware_launch/launch/autoware.launch.xml map_path:=/home/anonymous/ACsim/map_data/${map_name} vehicle_model:=sample_vehicle sensor_model:=sample_sensor_kit yolo_faulty_mode:=0 lidar_faulty_mode:=0 validation_faulty_mode:=0 shape_faulty_mode:=0 fusion_faulty_mode:=0 merger_faulty_mode:=0 dbt_faulty_mode:=0 tracker_faulty_mode:=1 yolo_timeLatencyDuration:=0 lidar_timeLatencyDuration:=0 shape_timeLatencyDuration:=0 fusion_timeLatencyDuration:=0 merger_timeLatencyDuration:=0 dbt_timeLatencyDuration:=0 tracker_timeLatencyDuration:=0
```

#### Execution

- Please enter into carla_autoware in terminal.

  ```
  cd ~/ACsim/carla_autoware
  ```

- Execute `source ~/ACsim/autoware/install/setup.sh && python3 lidar_hira.py`.

Follow the same steps as described in Experiments E2. If you want to repeat group 18-19, please follow the same steps as described in E1.

## Common issues and solutions

### 1. Black screen of Rviz2

The display of rviz2 may occasionally be black due to tight display resources. It does not affect the experiment, it will automatically recover after running for a while.

### 2. Crash of Carla server

This is also due to the tight of resources, please stop the experiments and  wait for around 5 minutes, then you can restart the experiments.







